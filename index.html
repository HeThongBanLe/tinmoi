<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Trang web</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f0f2f5;
            color: #333;
        }

        .header {
            height: 56px;
            background-color: #2c3e50;
            color: white;
            display: flex;
            align-items: center;
            padding: 0 24px;
            position: fixed;
            width: 100%;
            top: 0;
            left: 0;
            z-index: 1000;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            justify-content: space-between;
        }

        .header h1 {
            font-size: 20px;
            font-weight: bold;
            flex-grow: 1;
        }
        
        #user-info {
            font-size: 14px;
            margin-right: 16px;
            display: none;
            text-align: right;
            white-space: nowrap;
        }

        .menu-toggle {
            font-size: 28px;
            cursor: pointer;
        }

        .sidebar {
            height: 100%;
            width: 0;
            position: fixed;
            z-index: 1001;
            top: 56px;
            left: 0;
            background-color: #34495e;
            overflow-x: hidden;
            transition: width 0.5s;
            padding-top: 16px;
        }

        .sidebar.active {
            width: 250px;
        }
        
        .main-content {
            margin-top: 56px;
            padding: 24px;
            transition: margin-left .5s;
        }
        
        .main-content.pushed {
            margin-left: 250px;
        }

        .sidebar a {
            padding: 16px 24px;
            text-decoration: none;
            font-size: 16px;
            color: white;
            display: block;
            transition: background-color 0.3s;
            border-bottom: 1px solid #2c3e50;
        }

        .sidebar a:hover {
            background-color: #575757;
        }
        
        .sidebar a:last-child {
            border-bottom: none;
        }

        /* Modal styling */
        .modal {
            display: none;
            position: fixed;
            z-index: 2000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0,0,0,0.6);
            justify-content: center;
            align-items: center;
        }

        .modal-content {
            background-color: white;
            padding: 32px;
            border-radius: 12px;
            box-shadow: 0 8px 16px rgba(0,0,0,0.2);
            width: 90%;
            max-width: 480px;
            position: relative;
        }
        
        .close-button {
            color: #aaa;
            font-size: 32px;
            font-weight: bold;
            position: absolute;
            top: 12px;
            right: 16px;
            cursor: pointer;
            transition: color 0.3s;
        }

        .close-button:hover,
        .close-button:focus {
            color: black;
        }
        
        .modal-content input {
            width: 100%;
            padding: 12px;
            margin: 10px 0;
            border: 1px solid #ccc;
            box-sizing: border-box;
            border-radius: 8px;
        }

        .modal-content button {
            background-color: #2c3e50;
            color: white;
            padding: 14px 24px;
            margin: 10px 0;
            border: none;
            cursor: pointer;
            width: 100%;
            border-radius: 8px;
            transition: background-color 0.3s;
        }

        .modal-content button:hover {
            background-color: #34495e;
        }

        #auth-status {
            margin-top: 12px;
            font-size: 14px;
            text-align: center;
            color: #e74c3c;
        }

        /* Page styling */
        .page {
            display: none;
            flex-direction: column;
            align-items: center;
            padding: 24px;
        }
        
        .back-btn {
            background-color: #95a5a6;
            color: white;
            padding: 10px 18px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            transition: background-color 0.3s;
            margin-bottom: 24px;
        }
        
        .back-btn:hover {
            background-color: #7f8c8d;
        }

        .form-container {
            width: 100%;
            max-width: 800px;
            padding: 24px;
            background-color: white;
            border-radius: 12px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }

        .form-container input, .form-container textarea {
            width: 100%;
            padding: 12px;
            margin-bottom: 16px;
            border: 1px solid #ccc;
            border-radius: 8px;
        }

        .form-container button {
            width: 100%;
            padding: 14px;
            background-color: #2980b9;
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            transition: background-color 0.3s;
        }

        .form-container button:hover {
            background-color: #3498db;
        }
        
        .add-item-btn {
            background-color: #27ae60;
            color: white;
            padding: 10px 16px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            margin-bottom: 12px;
        }

        .remove-item-btn {
            background-color: #e74c3c;
            color: white;
            padding: 8px 12px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
        }
        
        .item-card {
            background-color: #ecf0f1;
            padding: 16px;
            margin-bottom: 12px;
            border-radius: 8px;
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        /* News and Stats Container */
        #newsContainer {
            display: flex;
            flex-direction: column;
            gap: 24px;
            max-width: 800px;
            margin: 24px auto;
        }

        .news-card {
            background-color: white;
            padding: 24px;
            border-radius: 12px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
            position: relative;
            cursor: pointer;
            transition: transform 0.3s, box-shadow 0.3s;
        }

        .news-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 16px rgba(0,0,0,0.15);
        }

        .news-card h3 {
            margin-top: 0;
            font-size: 24px;
            color: #3498db;
        }

        .news-card p {
            font-size: 16px;
            color: #666;
            margin-top: 8px;
        }
        .news-card .author {
            font-style: italic;
            color: #888;
            font-size: 14px;
            margin-top: 12px;
            text-align: right;
        }
        .news-card img {
            max-width: 100%;
            height: auto;
            border-radius: 8px;
            margin-bottom: 16px;
        }

        .edit-news-btn {
            position: absolute;
            top: 12px;
            right: 12px;
            background-color: #f39c12;
            color: white;
            border: none;
            padding: 8px 12px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 12px;
            display: none;
        }
 .delete-news-btn {
    position: absolute;
    top: 48px; /* nằm dưới nút sửa */
    right: 12px;
    background-color: #e74c3c;
    color: white;
    border: none;
    padding: 8px 12px;
    border-radius: 8px;
    cursor: pointer;
    font-size: 12px;
    display: none;
}
.delete-news-btn:hover {
    background-color: #c0392b;
}

        /* Full Article Page Styling */
        #fullArticlePage, #statsEntryPage {
            max-width: 800px;
            margin: 80px auto 24px;
            background-color: white;
            border-radius: 12px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }
        
        #fullArticlePage .main-image {
            max-width: 100%;
            height: auto;
            border-radius: 8px;
            margin-bottom: 24px;
        }
        
        .member-item {
            background-color: #ecf0f1;
            padding: 16px;
            border-radius: 8px;
            margin-bottom: 12px;
            border-left: 4px solid #3498db;
        }

        @media (max-width: 600px) {
            .sidebar {
                width: 0;
            }
            .main-content.pushed {
                margin-left: 0;
            }
            .sidebar.active {
                width: 200px;
            }
        }
	#registrantNameInput { display: block !important; background: yellow; }
	 #statsEntryPage {
  	flex-direction: column;
 	 align-items: flex-start;
	}

.scroll-fixed-30cm {
  max-height: 30cm;

  /* fallback ~1134px */
  max-height: 1134px;

  overflow-y: auto;
  overflow-x: hidden;
  padding-right: 8px;
  box-sizing: border-box;
}

@media print {
  .scroll-fixed-30cm {
    max-height: none !important;
    overflow: visible !important;
  }
  table tr {
    -webkit-print-color-adjust: exact;
    print-color-adjust: exact;
  }
}

.duplicate-highlight {
  background-color: #ffe6e6 !important;
  border: 2px solid #ff4d4d !important;
  border-radius: 6px;
  padding: 4px;
}

@media print {
  table tr {
    -webkit-print-color-adjust: exact;
    print-color-adjust: exact;
  }
}


    </style>
</head>
<body class="bg-gray-100 font-sans">

    <div class="header">
        <span class="menu-toggle" id="menuToggle">&#9776;</span>
        <h1 class="text-xl font-bold ml-4">Tin tức & Thống kê</h1>
        <div id="user-info"></div>
    </div>

    <div id="mySidebar" class="sidebar">
        <a href="javascript:void(0)" id="loginBtn">Đăng nhập</a>
        <a href="javascript:void(0)" id="newsBtn" style="display:none;">Tin mới</a>
        <a href="javascript:void(0)" id="statsBtn" style="display:none;">Thống kê</a>
        <a href="javascript:void(0)" id="changePasswordBtn" style="display:none;">Đổi mật khẩu</a>
        <a href="javascript:void(0)" id="createAccountBtn" style="display:none;">Tạo tài khoản</a>
        <a href="javascript:void(0)" id="settingsBtn" style="display:none;">Cấu hình</a>
        <a href="javascript:void(0)" id="logoutBtn" style="display:none;">Đăng xuất</a>
    </div>

    <div id="main" class="main-content">
        <div id="newsContainer"></div>
    </div>
    
    <div id="newsPage" class="page">
        <button class="back-btn" id="backFromNewsBtn" style="margin-top: 1cm;">Quay lại</button>
        <div class="form-container">
            <h2 id="newsPageTitle" class="text-2xl font-bold mb-4">Viết bài mới</h2>
            <input type="text" id="newsTitle" placeholder="Tiêu đề bài viết">
            <input type="text" id="newsImageUrl" placeholder="Tên ảnh, VD tenanh.png">
            <input type="text" id="newsDescription" placeholder="Mô tả ngắn">
            <div id="chaptersContainer"></div>
            <button class="add-item-btn" id="addChapterBtn">Thêm chương</button>
	    <button class="add-item-btn" id="addFieldBtn" style="display:none;">Thêm trường</button>
            <button id="submitNewsBtn" class="bg-blue-500 hover:bg-blue-600">Đăng bài</button>
        </div>
    </div>

<div id="statsEntryPage" class="page">
  <button class="back-btn" id="backFromStatsBtn">Quay lại</button>
  <div class="form-container" style="display:flex; flex-direction:column; gap:1rem;">
    <h2 id="statsEntryPageTitle" class="text-2xl font-bold mb-4">
      Nhập liệu thống kê hộ gia đình
    </h2>

    <!-- Ô cố định -->
    <div class="fixed-fields item-card mb-4">
      <label for="registrantNameInput" class="block mb-2 font-semibold">Nhập đầy đủ thông tin người đăng ký</label>
      <input type="text" id="registrantNameInput" class="w-full p-2 border rounded" placeholder="Nhập tên người đăng ký">
    </div>
     <div class="text-gray-600 mb-4">
      <p>Để thống kê, vui lòng nhập đầy đủ thông tin bên dưới.</p>
    </div>



    <!-- Chỗ chứa form động -->
    <div id="householdFormContainer" class="flex flex-col gap-4"></div>

    <button class="add-item-btn" id="addPersonBtn">Thêm người</button>
    <button id="saveHouseholdBtn" class="bg-green-500 hover:bg-green-600">Lưu thông tin</button>
    <hr class="my-2 border-t-2 border-gray-400">
    <div id="savedHouseholdData" class="mt-8">
      
	 <!-- 👇 Ô tìm kiếm -->
      <input type="text" id="householdSearch" class="w-full p-2 border rounded mb-4" placeholder="Tìm kiếm...">
	<button id="exportHouseholdsBtn" class="bg-blue-500 text-white px-4 py-2 rounded mb-4">
	 Xem dạng bảng
	</button>
	<button id="printHouseholdsBtn"class="bg-green-500 text-white px-4 py-2 rounded mb-4">
  	In danh sách
	</button>
	<button id="exportExcelBtn" class="bg-red-500 text-white px-4 py-2 rounded mb-4">
 	 Xuất Excel
	</button>
	<button id="downloadPdfBtn" class="bg-red-500 text-white px-4 py-2 rounded mb-4">
 	 Xuất PDF
	</button>


	<h3 class="text-lg font-bold mb-6 text-green-600">Danh sách đã đăng ký:</h3>
	<div id="householdList" class="flex flex-col gap-4 scroll-fixed-30cm"></div>
	<!-- Khu vực hiển thị Excel -->
	<div id="exportTableWrapper" class="scroll-fixed-30cm mt-6">
 	 <div id="exportTableContainer" class="overflow-x-auto"></div>
	</div>
      
    </div>
  </div>
</div>


    <!-- Trang Cấu hình -->
    <div id="settingsPage" class="page">
        <button class="back-btn" id="backFromSettingsBtn" style="margin-top: 1cm;">Quay lại</button>
        <div class="form-container">
            <h2 class="text-2xl font-bold mb-4">Cấu hình</h2>
            <p class="text-gray-600 mb-4">Để tải ảnh lên, bạn có thể sử dụng các dịch vụ lưu trữ hình ảnh miễn phí. Sau khi tải lên, bạn sẽ nhận được một đường link để dán vào trường "Tên ảnh, VD tenanh.png".</p>
            <div class="mt-6">
                <h3 class="font-bold">Hướng dẫn các bước:</h3>
                <ol class="list-decimal list-inside text-gray-700 mt-2">
                    <li>Truy cập một dịch vụ lưu trữ ảnh miễn phí như <a href="https://imgur.com/upload" target="_blank" class="text-blue-500 hover:underline">Imgur</a>.</li>
                    <li>Tải ảnh của bạn lên.</li>
                    <li>Sao chép đường link của ảnh đã tải lên.</li>
                    <li>Quay lại trang "Viết bài mới" và dán đường link đó vào trường "Đường dẫn ảnh mô tả".</li>
                </ol>
            </div>
        </div>
    </div>

    <!-- The Modal -->
    <div id="loginModal" class="modal">
        <div class="modal-content">
            <span class="close-button">&times;</span>
            <h2 class="text-2xl font-bold text-center mb-4">Đăng nhập</h2>
            <input type="email" id="emailInput" placeholder="Email" required>
            <input type="password" id="passwordInput" placeholder="Mật khẩu" required>
            <button id="loginSubmitBtn">Đăng nhập</button>
            <div id="auth-status"></div>
        </div>
    </div>
    
    <!-- Change Password Modal -->
    <div id="changePasswordModal" class="modal">
        <div class="modal-content">
            <span class="close-button">&times;</span>
            <h2 class="text-2xl font-bold text-center mb-4">Đổi mật khẩu</h2>
            <input type="password" id="newPasswordInput" placeholder="Mật khẩu mới" required>
            <button id="changePasswordSubmitBtn">Xác nhận</button>
            <div id="password-status"></div>
        </div>
    </div>
    
    <!-- Create Account Modal -->
    <div id="createAccountModal" class="modal">
        <div class="modal-content">
            <span class="close-button">&times;</span>
            <h2 class="text-2xl font-bold text-center mb-4">Tạo tài khoản mới</h2>
            <input type="email" id="newEmailInput" placeholder="Email" required>
            <input type="password" id="newPasswordInput2" placeholder="Mật khẩu" required>
            <button id="createAccountSubmitBtn">Tạo</button>
            <div id="create-status"></div>
        </div>
    </div>
    
    <!-- Full Article Page -->
    <div id="fullArticlePage" class="page">
        <button class="back-btn" id="backToMainBtn">Quay lại trang chính</button>
        <div class="form-container">
            <h2 id="articleTitle" class="text-3xl font-bold mb-4 text-center"></h2>
            <img id="articleImage" class="main-image" src="" alt="Hình ảnh">
            <p id="articleDescription" class="text-gray-700 mb-6"></p>
            <div id="articleChapters"></div>
            <div class="author text-sm text-gray-500 mt-6" id="articleAuthor"></div>
        </div>
    </div>

    <script type="module">
        // Firebase configuration
        const firebaseConfig = {
          apiKey: "AIzaSyDnpmDzGFRI9xO9EEtEpI08Eq7eStFlmrs",
          authDomain: "tintuc-abf6f.firebaseapp.com",
          projectId: "tintuc-abf6f",
          storageBucket: "tintuc-abf6f.firebasestorage.app",
          messagingSenderId: "331457798860",
          appId: "1:331457798860:web:5d36bb68868323669b9869",
          measurementId: "G-RX51JVRPEC"
        };
        
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';

        // Firebase Imports
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInWithEmailAndPassword, signOut, onAuthStateChanged, updatePassword, createUserWithEmailAndPassword } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
       import { getFirestore, collection, addDoc, onSnapshot, query, setLogLevel, updateDoc, doc, getDocs, deleteDoc } 
    from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";


        
        setLogLevel('debug');
        
        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // Global state variables
        let editingDocId = null;
        let currentPostType = 'news';
        let currentStatsPostId = null;
	let currentStatsFields = [];
	// expose ra window để script khác (non-module) có thể đọc
	window.currentStatsFields = currentStatsFields;
	window.currentHouseholds = []; // cache households hiện tại
        // UI elements
        const sidebar = document.getElementById("mySidebar");
        const mainContent = document.getElementById("main");
        const newsPage = document.getElementById("newsPage");
        const settingsPage = document.getElementById("settingsPage");
        const newsContainer = document.getElementById("newsContainer");
        const loginBtn = document.getElementById("loginBtn");
        const newsBtn = document.getElementById("newsBtn");
        const statsBtn = document.getElementById("statsBtn");
        const logoutBtn = document.getElementById("logoutBtn");
        const changePasswordBtn = document.getElementById("changePasswordBtn");
        const createAccountBtn = document.getElementById("createAccountBtn");
        const settingsBtn = document.getElementById("settingsBtn");
        const userInfo = document.getElementById("user-info");
        const emailInput = document.getElementById("emailInput");
        const passwordInput = document.getElementById("passwordInput");
        const newsTitleInput = document.getElementById("newsTitle");
        const newsImageUrlInput = document.getElementById("newsImageUrl");
        const newsDescriptionInput = document.getElementById("newsDescription");
        const chaptersContainer = document.getElementById("chaptersContainer");
        const addChapterBtn = document.getElementById("addChapterBtn");
	const addFieldBtn = document.getElementById("addFieldBtn");
        const menuToggle = document.getElementById("menuToggle");
        const submitNewsBtn = document.getElementById("submitNewsBtn");
        const newsPageTitle = document.getElementById("newsPageTitle");
        
        const fullArticlePage = document.getElementById("fullArticlePage");
        const articleTitle = document.getElementById("articleTitle");
        const articleImage = document.getElementById("articleImage");
        const articleDescription = document.getElementById("articleDescription");
        const articleChapters = document.getElementById("articleChapters");
        const articleAuthor = document.getElementById("articleAuthor");

        const statsEntryPage = document.getElementById("statsEntryPage");
        const statsEntryPageTitle = document.getElementById("statsEntryPageTitle");
        const householdFormContainer = document.getElementById("householdFormContainer");
        const addPersonBtn = document.getElementById("addPersonBtn");
        const saveHouseholdBtn = document.getElementById("saveHouseholdBtn");
        const householdList = document.getElementById("householdList");
	const householdSearch = document.getElementById("householdSearch");

        const backToMainBtn = document.getElementById("backToMainBtn");
        const backFromSettingsBtn = document.getElementById("backFromSettingsBtn");
        const backFromNewsBtn = document.getElementById("backFromNewsBtn");
        const backFromStatsBtn = document.getElementById("backFromStatsBtn");

        // Modals
        const loginModal = document.getElementById("loginModal");
        const changePasswordModal = document.getElementById("changePasswordModal");
        const createAccountModal = document.getElementById("createAccountModal");
        
	const exportHouseholdsBtn = document.getElementById("exportHouseholdsBtn");
	const printHouseholdsBtn = document.getElementById("printHouseholdsBtn");
	const exportExcelBtn = document.getElementById("exportExcelBtn");
	const downloadPdfBtn = document.getElementById("downloadPdfBtn");

	
        // Close buttons for modals
        document.querySelectorAll(".close-button").forEach(btn => {
            btn.onclick = function() {
                btn.closest('.modal').style.display = "none";
            }
        });
        
        window.onclick = function(event) {
            if (event.target.classList.contains('modal')) {
                event.target.style.display = "none";
            }
        }
        
        // Login functionality
        loginBtn.onclick = () => loginModal.style.display = "flex";
        
        document.getElementById("loginSubmitBtn").onclick = async function() {
            const authStatus = document.getElementById("auth-status");
            const email = emailInput.value;
            const password = passwordInput.value;
            authStatus.textContent = "Đang đăng nhập...";

            try {
                await signInWithEmailAndPassword(auth, email, password);
                authStatus.textContent = "Đăng nhập thành công!";
                loginModal.style.display = "none";
            } catch (error) {
                console.error("Lỗi đăng nhập:", error);
                authStatus.textContent = "Lỗi: " + error.message;
            }
        };
        
        // Logout functionality
        logoutBtn.onclick = () => signOut(auth).catch(error => console.error("Lỗi đăng xuất:", error));
        
        // Change password functionality
        changePasswordBtn.onclick = () => changePasswordModal.style.display = "flex";
        
        document.getElementById("changePasswordSubmitBtn").onclick = async function() {
            const newPasswordInput = document.getElementById("newPasswordInput");
            const passwordStatus = document.getElementById("password-status");
            const user = auth.currentUser;
            if (user) {
                try {
                    await updatePassword(user, newPasswordInput.value);
                    passwordStatus.textContent = "Đổi mật khẩu thành công!";
                } catch (error) {
                    console.error("Lỗi đổi mật khẩu:", error);
                    passwordStatus.textContent = "Lỗi: " + error.message;
                }
            }
        };
        
        // Create account functionality
        createAccountBtn.onclick = () => createAccountModal.style.display = "flex";
        
        document.getElementById("createAccountSubmitBtn").onclick = async function() {
            const newEmailInput = document.getElementById("newEmailInput");
            const newPasswordInput2 = document.getElementById("newPasswordInput2");
            const createStatus = document.getElementById("create-status");
            try {
                await createUserWithEmailAndPassword(auth, newEmailInput.value, newPasswordInput2.value);
                createStatus.textContent = "Tạo tài khoản thành công!";
            } catch (error) {
                console.error("Lỗi tạo tài khoản:", error);
                createStatus.textContent = "Lỗi: " + error.message;
            }
        };
        
        // Add chapter functionality for news/stats post
        function addChapter(title = '', imageUrl = '', content = '') {
            const chapterDiv = document.createElement('div');
            chapterDiv.classList.add('item-card');
            chapterDiv.innerHTML = `
                <input type="text" class="chapter-title-input" placeholder="Tiêu đề chương" value="${title}">
                <input type="text" class="chapter-image-input" placeholder="Đường dẫn ảnh chương" value="${imageUrl}">
                <textarea class="chapter-content-input h-32" placeholder="Nội dung chương">${content}</textarea>
                <button class="remove-item-btn">Xóa chương</button>
            `;
            chaptersContainer.appendChild(chapterDiv);
            chapterDiv.querySelector('.remove-item-btn').onclick = () => chapterDiv.remove();
        }
        addChapterBtn.onclick = () => { if (currentPostType === 'news') addChapter(); };
	addFieldBtn.onclick = () => { if (currentPostType === 'stats') addField(); };
	// --- Thêm field cho bài thống kê ---
function addField(fieldName = '') {
    const div = document.createElement('div');
    div.classList.add('item-card');
    div.innerHTML = `
        <input type="text" class="field-name-input" placeholder="Tên trường (vd: Họ tên, Nghề nghiệp)" value="${fieldName}">
        <button class="remove-item-btn">Xóa</button>
    `;
    chaptersContainer.appendChild(div);
    div.querySelector('.remove-item-btn').onclick = () => div.remove();
}

        // Submit news/stats functionality
submitNewsBtn.onclick = async function() {
    const user = auth.currentUser;
    if (!user) return;

    const postData = {
        title: newsTitleInput.value,
        description: newsDescriptionInput.value,
        imageUrl: newsImageUrlInput.value || '',
        author: user.email,
        type: currentPostType,
        createdAt: new Date()
    };

    // Nếu là news: lấy các item bên trong chaptersContainer (chỉ các chapter)
    if (currentPostType === 'news') {
        postData.chapters = Array.from(chaptersContainer.querySelectorAll('.item-card')).map(el => ({
            title: (el.querySelector('.chapter-title-input')?.value) || '',
            imageUrl: (el.querySelector('.chapter-image-input')?.value) || '',
            content: (el.querySelector('.chapter-content-input')?.value) || ''
        }));
    }

    // Nếu là stats: lấy các field-name-input trong chaptersContainer
    if (currentPostType === 'stats') {
        postData.fields = Array.from(chaptersContainer.querySelectorAll('.field-name-input'))
            .map(input => input.value)
            .filter(v => v.trim() !== '');
    }

    if (!postData.title || !postData.description) {
        console.log("Vui lòng điền đầy đủ tiêu đề và mô tả.");
        return;
    }

    try {
        if (editingDocId) {
            await updateDoc(doc(db, `/artifacts/${appId}/public/data/news`, editingDocId), postData);
            console.log("Bài viết đã được cập nhật thành công!");
        } else {
            await addDoc(collection(db, `/artifacts/${appId}/public/data/news`), postData);
            console.log("Bài viết đã được đăng thành công!");
        }
    } catch (e) {
        console.error("Lỗi khi đăng/cập nhật bài viết: ", e);
    }

    // Clear inputs and switch back to main page
    editingDocId = null;
    submitNewsBtn.textContent = "Đăng bài";
    newsTitleInput.value = newsImageUrlInput.value = newsDescriptionInput.value = "";
    chaptersContainer.innerHTML = "";
    showPage('main');
};

        
        function showPage(pageId) {
            document.querySelectorAll('.page, .main-content').forEach(page => page.style.display = 'none');
            document.getElementById(pageId).style.display = 'flex';
        }

        // Navigation button functionality
        newsBtn.onclick = () => {
            currentPostType = 'news';
            newsPageTitle.textContent = "Viết tin mới";
            editingDocId = null;
            submitNewsBtn.textContent = "Đăng bài";
            newsTitleInput.value = newsImageUrlInput.value = newsDescriptionInput.value = "";
            chaptersContainer.innerHTML = "";
            showPage('newsPage');
	    addChapter();
	    addChapterBtn.style.display = 'inline-block';
	    addFieldBtn.style.display = 'none';
        };

       statsBtn.onclick = () => {
    currentPostType = 'stats';
    newsPageTitle.textContent = "Tạo mẫu thống kê";
    editingDocId = null;
    submitNewsBtn.textContent = "Đăng bài";
    newsTitleInput.value = newsImageUrlInput.value = newsDescriptionInput.value = "";
    chaptersContainer.innerHTML = "";
    showPage('newsPage');
    
    addField(); // 👈 thống kê thì thêm trường
    addChapterBtn.style.display = 'none';
    addFieldBtn.style.display = 'inline-block';

};


        settingsBtn.onclick = () => showPage('settingsPage');
        backToMainBtn.onclick = () => showPage('main');
        backFromSettingsBtn.onclick = () => showPage('main');
        backFromNewsBtn.onclick = () => showPage('main');
        backFromStatsBtn.onclick = () => showPage('main');

        // Auth state listener
        onAuthStateChanged(auth, (user) => {
            if (user) {
                userInfo.textContent = `Xin chào, ${user.email}`;
                userInfo.style.display = "block";
                loginBtn.style.display = "none";
                logoutBtn.style.display = "block";
                changePasswordBtn.style.display = "block";
                newsBtn.style.display = "block";
                statsBtn.style.display = "block";
                settingsBtn.style.display = "block";
		newBtn.style.display = "block";
	    

                if (user.email === 'admin@myapp.com') {
                    createAccountBtn.style.display = "block";
                } else {
                    createAccountBtn.style.display = "none";
                }
            } else {
                userInfo.style.display = "none";
                loginBtn.style.display = "block";
                logoutBtn.style.display = "none";
                changePasswordBtn.style.display = "none";
                createAccountBtn.style.display = "none";
                settingsBtn.style.display = "none";
                statsBtn.style.display = "none";
		newBtn.style.display = "none";
                passwordInput.value = "";
        	
		
            }
        });


        // Listen for news and stats articles
        onSnapshot(query(collection(db, `/artifacts/${appId}/public/data/news`)), (querySnapshot) => {
            const newsList = querySnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() })).sort((a, b) => b.createdAt.toDate() - a.createdAt.toDate());
            
            newsContainer.innerHTML = '';
            const user = auth.currentUser;
            newsList.forEach(news => {
                const card = document.createElement('div');
                card.classList.add('news-card');
                
                let imageHtml = news.imageUrl ? `<img src="${news.imageUrl}" alt="${news.title}" onerror="this.style.display='none'">` : '';
                card.innerHTML = `
                    ${imageHtml}
                    <h3>${news.title}</h3>
                    <p>${news.description}</p>
                    <div class="author">Đăng bởi: ${news.author}</div>
                    <button class="edit-news-btn">Sửa</button>
		    <button class="delete-news-btn">Xóa</button>
                `;
                newsContainer.appendChild(card);

                const editBtn = card.querySelector('.edit-news-btn');
                if (user && user.email === news.author) {
                    editBtn.style.display = 'block';
                } else {
                    editBtn.style.display = 'none';
                }

              editBtn.onclick = (e) => {
    e.stopPropagation();
    editingDocId = news.id;
    currentPostType = news.type;
    newsPageTitle.textContent = news.type === 'news' ? "Viết tin mới" : "Viết bài thống kê";
    newsTitleInput.value = news.title;
    newsImageUrlInput.value = news.imageUrl || '';
    newsDescriptionInput.value = news.description || '';

    chaptersContainer.innerHTML = '';

    if (news.type === 'news') {
        // populate chapters
        (news.chapters || []).forEach(chapter => addChapter(chapter.title, chapter.imageUrl, chapter.content));
    } else if (news.type === 'stats') {
        // populate fields for stats
        (news.fields || []).forEach(fieldName => addField(fieldName));
    }

    submitNewsBtn.textContent = "Cập nhật bài viết";
    showPage('newsPage');
};



		const deleteBtn = card.querySelector('.delete-news-btn');
if (user && user.email === news.author) {
    deleteBtn.style.display = 'block';
} else {
    deleteBtn.style.display = 'none';
}

deleteBtn.onclick = async (e) => {
    e.stopPropagation();
    if (confirm("Bạn có chắc chắn muốn xóa bài viết này không?")) {
        try {
            // Nếu là bài thống kê => xóa households trước
            if (news.type === 'stats') {
                const householdsRef = collection(db, `/artifacts/${appId}/public/data/news/${news.id}/households`);
                const householdsSnap = await getDocs(householdsRef);
                for (const hDoc of householdsSnap.docs) {
                    await deleteDoc(hDoc.ref);
                }
            }
            // Xóa document chính
            await deleteDoc(doc(db, `/artifacts/${appId}/public/data/news`, news.id));
            console.log("Bài viết đã bị xóa!");
        } catch (error) {
            console.error("Lỗi khi xóa bài viết:", error);
        }
    }
};



                card.onclick = () => {
                    if (news.type === 'news') {
                        // Show full article page for news
                        articleTitle.textContent = news.title;
                        articleDescription.textContent = news.description;
                        articleAuthor.textContent = `Đăng bởi: ${news.author}`;

                        if (news.imageUrl) {
                            articleImage.src = news.imageUrl;
                            articleImage.style.display = 'block';
                        } else {
                            articleImage.style.display = 'none';
                        }
                        
                        articleChapters.innerHTML = '';
                        news.chapters.forEach(chapter => {
                            const chapterDiv = document.createElement('div');
                            chapterDiv.innerHTML = `
                                <h4 class="text-xl font-bold mt-6 mb-2">${chapter.title}</h4>
                                ${chapter.imageUrl ? `<img src="${chapter.imageUrl}" class="w-full h-auto rounded-lg mb-4" alt="${chapter.title}" onerror="this.style.display='none'">` : ''}
                                <p class="text-gray-700 leading-relaxed whitespace-pre-wrap">${chapter.content}</p>
                            `;
                            articleChapters.appendChild(chapterDiv);
                        });
                        showPage('fullArticlePage');
                        window.scrollTo(0, 0);
                    }
else if (news.type === 'stats') {
    currentStatsPostId = news.id;
    statsEntryPageTitle.textContent = `Thống kê cho: ${news.title}`;
    currentStatsFields = news.fields || []; // lấy danh sách fields do người tạo định nghĩa
    window.currentStatsFields = currentStatsFields;
    showPage('statsEntryPage');




    // Reset form nhập hộ gia đình
    //householdFormContainer.innerHTML = '';
    addPerson(currentStatsFields); // tạo form mới dựa vào fields

    // Subscribe to households for this stats post (re-subscribe whenever opening a stats post)
    subscribeHouseholds(currentStatsPostId);
}


                };
            });
        });

        // Logic for Stats Entry Page
      function addPerson(fields, person = {}) {
    const div = document.createElement('div');
    div.classList.add('item-card');

    fields.forEach(fieldName => {
        const val = person[fieldName] || '';
        div.innerHTML += `
            <input type="text" class="field-input" data-field="${fieldName}" placeholder="${fieldName}" value="${val}">
        `;
    });

    div.innerHTML += `<button class="remove-item-btn">Xóa người</button>`;
    div.querySelector('.remove-item-btn').onclick = () => div.remove();

    householdFormContainer.appendChild(div);
}

let unsubscribeHouseholds = null; // global để huỷ subscription cũ nếu cần

function subscribeHouseholds(postId) {
    // Huỷ subscription cũ nếu có
    if (typeof unsubscribeHouseholds === 'function') {
        unsubscribeHouseholds();
        unsubscribeHouseholds = null;
    }

    if (!postId) {
        householdList.innerHTML = '';
        return;
    }

    const collRef = collection(db, `/artifacts/${appId}/public/data/news/${postId}/households`);
    const q = query(collRef);

    unsubscribeHouseholds = onSnapshot(q, (querySnapshot) => {
	window.currentHouseholds = querySnapshot.docs.map(docSnap => ({ id: docSnap.id, ...docSnap.data() }));
        householdList.innerHTML = '';
        // khi lắng nghe households:
querySnapshot.forEach(docSnap => {
    const data = docSnap.data();
    const listDiv = document.createElement('div');
    listDiv.classList.add('member-item');

    let memberInfo = '';
    (data.members || []).forEach(member => {
        for (const key in member) {
            memberInfo += `<p><strong>${key}:</strong> ${member[key]}</p>`;
        }
        memberInfo += `<hr>`;
    });

    listDiv.innerHTML = `
      <p><strong>Người đăng ký:</strong> ${data.registrantName || 'Không rõ'}</p>
      <p class="text-sm text-gray-500">Được khai báo lúc:  ${data.declaredAt?.toDate ? data.declaredAt.toDate().toLocaleString('vi-VN') : data.declaredAt}</p>
      ${memberInfo}
    `;
    householdList.appendChild(listDiv);
});

    }, (err) => {
        console.error("Lỗi khi lắng nghe households:", err);
    });
}

        addPersonBtn.onclick = () => addPerson(currentStatsFields);


 saveHouseholdBtn.onclick = async function() {
    if (!currentStatsPostId) {
        alert("Không có bài thống kê nào đang được chọn.");
        return;
    }

    if (!currentStatsFields || currentStatsFields.length === 0) {
        alert("Bài thống kê này chưa có trường nào, không thể nhập liệu.");
        return;
    }
    const registrantName = document.getElementById('registrantNameInput').value.trim();
    const householdData = Array.from(householdFormContainer.querySelectorAll('.item-card')).map(el => {
        const member = {};
        el.querySelectorAll('.field-input').forEach(input => {
            member[input.dataset.field] = input.value.trim();
        });
        return member;
    });

    // Kiểm tra có dữ liệu thực sự
    const hasAnyData = householdData.some(member => 
        Object.values(member).some(v => v !== "")
    );
    if (!hasAnyData) {
        alert("Vui lòng nhập ít nhất một thông tin trước khi lưu!");
        return;
    }

    const user = auth.currentUser;
    const declaredBy = user && user.email ? user.email : "anonymous";

    try {
        await addDoc(
            collection(db, `/artifacts/${appId}/public/data/news/${currentStatsPostId}/households`),
            {	
		registrantName, 
                members: householdData,
                declaredBy,
                declaredAt: new Date()
            }
        );
        console.log("✅ Lưu thành công");
        householdFormContainer.innerHTML = '';
        addPerson(currentStatsFields);
    } catch (e) {
        console.error("❌ Lỗi khi lưu dữ liệu hộ gia đình:", e);
        alert("Có lỗi khi lưu dữ liệu, thử lại sau.");
    }
};



        // Listen for household data changes on the current stats post
        onSnapshot(query(collection(db, `/artifacts/${appId}/public/data/news/${currentStatsPostId || 'placeholder'}/households`)), (querySnapshot) => {
            householdList.innerHTML = '';
            querySnapshot.forEach(doc => {
                const data = doc.data();
                const listDiv = document.createElement('div');
                listDiv.classList.add('member-item');
                let memberInfo = ``;
   data.members.forEach(member => {
    for (const key in member) {
        memberInfo += `<p><strong>${key}:</strong> ${member[key]}</p>`;
    }
    memberInfo += `<hr>`;
});



                listDiv.innerHTML = `
  		<p><strong>Người đăng ký:</strong> ${data.registrantName || 'Không rõ'}</p>
  		<p class="text-sm text-gray-500">Được khai báo bởi:  ${data.declaredAt.toDate().toLocaleString('vi-VN')}</p>
  		${memberInfo}
		`;

                householdList.appendChild(listDiv);
            });
        });


        // Toggle sidebar using a button
        menuToggle.onclick = () => {
            sidebar.classList.toggle('active');
            mainContent.classList.toggle('pushed');
        };

        // Close sidebar when clicking outside on mobile
        window.addEventListener('click', (e) => {
            if (sidebar.classList.contains('active') && !sidebar.contains(e.target) && !menuToggle.contains(e.target)) {
                sidebar.classList.remove('active');
                mainContent.classList.remove('pushed');
            }
        });
        
    </script>
<script>
document.addEventListener("DOMContentLoaded", () => {
  const householdSearch = document.getElementById("householdSearch");
  const householdList = document.getElementById("householdList");

  if (!householdSearch || !householdList) return;

  householdSearch.addEventListener("input", function() {
    const query = this.value.toLowerCase().trim();
    const items = householdList.querySelectorAll(".member-item");

    items.forEach(item => {
      const text = item.textContent.replace(/\s+/g, " ").toLowerCase();
      if (text.includes(query)) {
        item.style.display = "block"; // hiển thị
      } else {
        item.style.display = "none";  // ẩn đi
      }
    });
  });
});

</script>
<script>
// nút export (lưu dạng bảng giống excel)
document.getElementById("exportHouseholdsBtn").addEventListener("click", () => {
  const container = document.getElementById("exportTableContainer");
  container.innerHTML = "";

  // tiêu đề thống kê trên cùng
  const titleText = document.getElementById("statsEntryPageTitle")?.textContent || "Danh sách thống kê";
  const title = document.createElement("h3");
  title.className = "text-xl font-bold mb-4";
  title.textContent = titleText;
  container.appendChild(title);

  const fields = window.currentStatsFields || [];
  const households = window.currentHouseholds || [];

  // tạo bảng
  const table = document.createElement("table");
  table.className = "table-auto border-collapse border border-gray-400 w-full text-sm";

  // header
  const thead = document.createElement("thead");
  const headerRow = document.createElement("tr");
  headerRow.innerHTML = `<th class="border px-2 py-1">Người đăng ký</th>`;
  fields.forEach(f => headerRow.innerHTML += `<th class="border px-2 py-1">${f}</th>`);
  thead.appendChild(headerRow);
  table.appendChild(thead);

  // body
  const tbody = document.createElement("tbody");


  // chọn màu xen kẽ cho từng hộ
households.forEach((hh, index) => {
  const registrant = hh.registrantName || "";

  // Nếu có người đăng ký thì xen kẽ 2 màu, còn không thì để trắng
  const bgColor = registrant
    ? (index % 2 === 0 ? "#fff3cd" : "#d1ecf1")
    : "";

  (hh.members || []).forEach(member => {
    const tr = document.createElement("tr");
    tr.innerHTML = `<td class="border px-2 py-1 font-bold">${registrant}</td>`;
    fields.forEach(f => {
      tr.innerHTML += `<td class="border px-2 py-1">${member[f] || ""}</td>`;
    });

    if (bgColor) {
      tr.style.backgroundColor = bgColor;
    }

    tbody.appendChild(tr);
  });
});


  table.appendChild(tbody);

  container.appendChild(table);
  container.scrollIntoView({ behavior: "smooth" });
});

document.getElementById("printHouseholdsBtn").addEventListener("click", () => {
  const container = document.getElementById("exportTableContainer");
  if (!container || !container.innerHTML.trim()) {
    alert("Chưa có dữ liệu để in. Hãy bấm 'Lưu danh sách' trước.");
    return;
  }

  // mở cửa sổ in
  const printWindow = window.open("", "_blank");
printWindow.document.write(`
  <html>
    <head>
      <title>In danh sách</title>
      <style>
        body { font-family: sans-serif; padding: 20px; }
        h3 { margin-bottom: 20px; }
        table { border-collapse: collapse; width: 100%; }
        th, td { border: 1px solid #333; padding: 6px 10px; text-align: left; }
        th { background: #f0f0f0; }
        @media print {
          table tr {
            -webkit-print-color-adjust: exact;
            print-color-adjust: exact;
          }
        }
      </style>
    </head>
    <body>
      ${container.innerHTML}
    </body>
  </html>
`);

  printWindow.document.close();
  printWindow.print();
});

</script>


<script>
document.getElementById("exportExcelBtn").addEventListener("click", () => {
  const table = document.querySelector("#exportTableContainer table");
  if (!table) {
    alert("⚠️ Chưa có dữ liệu để xuất Excel. Hãy bấm 'Xem dạng bảng' trước.");
    return;
  }

  // 👉 lấy tiêu đề động từ giao diện
  const titleText = document.getElementById("statsEntryPageTitle")?.textContent || "Danh sách thống kê";

  // lấy dữ liệu bảng HTML thành mảng (array of arrays)
  const data = XLSX.utils.sheet_to_json(
    XLSX.utils.table_to_sheet(table),
    { header: 1 } // lấy raw mảng, không object
  );

  // chèn tiêu đề vào dòng đầu
  data.unshift([titleText]);

  // tạo sheet từ mảng dữ liệu
  const ws = XLSX.utils.aoa_to_sheet(data);

  // tạo workbook và thêm sheet
  const wb = XLSX.utils.book_new();
  XLSX.utils.book_append_sheet(wb, ws, "Thống kê");

  // lưu file
  XLSX.writeFile(wb, "danhsach-thongke.xlsx");
});
</script>



<script>
document.getElementById("downloadPdfBtn").addEventListener("click", () => {
  const table = document.querySelector("#exportTableContainer table");
  if (!table) {
    alert("⚠️ Chưa có dữ liệu để xuất PDF. Hãy bấm 'Xem dạng bảng' trước.");
    return;
  }

  // lấy dữ liệu bảng HTML
  const rows = [];
  table.querySelectorAll("tr").forEach(tr => {
    const row = [];
    tr.querySelectorAll("th, td").forEach(td => {
      row.push(td.innerText.trim());
    });
    rows.push(row);
  });

  // 👉 lấy tiêu đề động giống hàm in
  const titleText = document.getElementById("statsEntryPageTitle")?.textContent || "Danh sách thống kê";

  const docDefinition = {
    pageSize: "A3",
    pageOrientation: "landscape",
    content: [
      { text: titleText, style: "title", alignment: "center" }, // 👈 tiêu đề động
      { text: "Ngày xuất: " + new Date().toLocaleDateString("vi-VN"), alignment: "right", margin: [0, 0, 0, 10] },
      {
        table: {
          headerRows: 1,
          widths: Array(rows[0].length).fill("auto"),
          body: rows
        },
        layout: 'grid'
      }
    ],
    styles: {
      title: {
        fontSize: 18,
        bold: true,
        margin: [0, 0, 0, 10]
      }
    },
    defaultStyle: {
      font: "Roboto",
      fontSize: 11
    }
  };

  pdfMake.createPdf(docDefinition).download("danhsach-thongke.pdf");
});


</script>


<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

<script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.2.7/pdfmake.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.2.7/vfs_fonts.js"></script>




</body>
</html>
