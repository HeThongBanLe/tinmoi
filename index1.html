<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Trang web</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f0f2f5;
            color: #333;
        }

        .header {
            height: 56px;
            background-color: #2c3e50;
            color: white;
            display: flex;
            align-items: center;
            padding: 0 24px;
            position: fixed;
            width: 100%;
            top: 0;
            left: 0;
            z-index: 1000;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            justify-content: space-between;
        }

        .header h1 {
            font-size: 20px;
            font-weight: bold;
            flex-grow: 1;
        }
        
        #user-info {
            font-size: 14px;
            margin-right: 16px;
            display: none;
            text-align: right;
            white-space: nowrap;
        }

        .menu-toggle {
            font-size: 28px;
            cursor: pointer;
        }

        .sidebar {
            height: 100%;
            width: 0;
            position: fixed;
            z-index: 1001;
            top: 56px;
            left: 0;
            background-color: #34495e;
            overflow-x: hidden;
            transition: width 0.5s;
            padding-top: 16px;
        }

        .sidebar.active {
            width: 250px;
        }
        
        .main-content {
            margin-top: 56px;
            padding: 24px;
            transition: margin-left .5s;
        }
        
        .main-content.pushed {
            margin-left: 250px;
        }

        .sidebar a {
            padding: 16px 24px;
            text-decoration: none;
            font-size: 16px;
            color: white;
            display: block;
            transition: background-color 0.3s;
            border-bottom: 1px solid #2c3e50;
        }

        .sidebar a:hover {
            background-color: #575757;
        }
        
        .sidebar a:last-child {
            border-bottom: none;
        }

        /* Modal styling */
        .modal {
            display: none;
            position: fixed;
            z-index: 2000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0,0,0,0.6);
            justify-content: center;
            align-items: center;
        }

        .modal-content {
            background-color: white;
            padding: 32px;
            border-radius: 12px;
            box-shadow: 0 8px 16px rgba(0,0,0,0.2);
            width: 90%;
            max-width: 480px;
            position: relative;
        }
        
        .close-button {
            color: #aaa;
            font-size: 32px;
            font-weight: bold;
            position: absolute;
            top: 12px;
            right: 16px;
            cursor: pointer;
            transition: color 0.3s;
        }

        .close-button:hover,
        .close-button:focus {
            color: black;
        }
        
        .modal-content input {
            width: 100%;
            padding: 12px;
            margin: 10px 0;
            border: 1px solid #ccc;
            box-sizing: border-box;
            border-radius: 8px;
        }

        .modal-content button {
            background-color: #2c3e50;
            color: white;
            padding: 14px 24px;
            margin: 10px 0;
            border: none;
            cursor: pointer;
            width: 100%;
            border-radius: 8px;
            transition: background-color 0.3s;
        }

        .modal-content button:hover {
            background-color: #34495e;
        }

        #auth-status {
            margin-top: 12px;
            font-size: 14px;
            text-align: center;
            color: #e74c3c;
        }

        /* Page styling */
        .page {
            display: none;
            flex-direction: column;
            align-items: center;
            padding: 24px;
        }
        
        .back-btn {
            background-color: #95a5a6;
            color: white;
            padding: 10px 18px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            transition: background-color 0.3s;
            margin-bottom: 24px;
        }
        
        .back-btn:hover {
            background-color: #7f8c8d;
        }

        .form-container {
            width: 100%;
            max-width: 800px;
            padding: 24px;
            background-color: white;
            border-radius: 12px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }

        .form-container input, .form-container textarea {
            width: 100%;
            padding: 12px;
            margin-bottom: 16px;
            border: 1px solid #ccc;
            border-radius: 8px;
        }

        .form-container button {
            width: 100%;
            padding: 14px;
            background-color: #2980b9;
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            transition: background-color 0.3s;
        }

        .form-container button:hover {
            background-color: #3498db;
        }
        
        .add-item-btn {
            background-color: #27ae60;
            color: white;
            padding: 10px 16px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            margin-bottom: 12px;
        }

        .remove-item-btn {
            background-color: #e74c3c;
            color: white;
            padding: 8px 12px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
        }
        
        .item-card {
            background-color: #ecf0f1;
            padding: 16px;
            margin-bottom: 12px;
            border-radius: 8px;
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        /* News and Stats Container */
        #newsContainer {
            display: flex;
            flex-direction: column;
            gap: 24px;
            max-width: 800px;
            margin: 24px auto;
        }

        .news-card {
            background-color: white;
            padding: 24px;
            border-radius: 12px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
            position: relative;
            cursor: pointer;
            transition: transform 0.3s, box-shadow 0.3s;
        }

        .news-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 16px rgba(0,0,0,0.15);
        }

        .news-card h3 {
            margin-top: 0;
            font-size: 24px;
            color: #3498db;
        }

        .news-card p {
            font-size: 16px;
            color: #666;
            margin-top: 8px;
        }
        .news-card .author {
            font-style: italic;
            color: #888;
            font-size: 14px;
            margin-top: 12px;
            text-align: right;
        }
        .news-card img {
            max-width: 100%;
            height: auto;
            border-radius: 8px;
            margin-bottom: 16px;
        }

        .edit-news-btn {
            position: absolute;
            top: 12px;
            right: 12px;
            background-color: #f39c12;
            color: white;
            border: none;
            padding: 8px 12px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 12px;
            display: none;
        }

        /* Full Article Page Styling */
        #fullArticlePage, #statsEntryPage {
            max-width: 800px;
            margin: 80px auto 24px;
            background-color: white;
            border-radius: 12px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }
        
        #fullArticlePage .main-image {
            max-width: 100%;
            height: auto;
            border-radius: 8px;
            margin-bottom: 24px;
        }
        
        .member-item {
            background-color: #ecf0f1;
            padding: 16px;
            border-radius: 8px;
            margin-bottom: 12px;
            border-left: 4px solid #3498db;
        }
        
        #fullArticlePage .chapter {
            margin-top: 24px;
        }

        #fullArticlePage .chapter-title {
            font-size: 20px;
            font-weight: bold;
            color: #2c3e50;
            margin-bottom: 8px;
        }
        
        #fullArticlePage .chapter-image {
            max-width: 100%;
            height: auto;
            border-radius: 8px;
            margin-top: 12px;
            margin-bottom: 16px;
        }

        #fullArticlePage .chapter-content {
            white-space: pre-wrap;
            line-height: 1.6;
            color: #555;
        }


        @media (max-width: 600px) {
            .sidebar {
                width: 0;
            }
            .main-content.pushed {
                margin-left: 0;
            }
            .sidebar.active {
                width: 200px;
            }
        }
    </style>
</head>
<body class="bg-gray-100 font-sans">

    <div class="header">
        <span class="menu-toggle" id="menuToggle">&#9776;</span>
        <h1 class="text-xl font-bold ml-4">Tin tức & Thống kê</h1>
        <div id="user-info"></div>
    </div>

    <div id="mySidebar" class="sidebar">
        <a href="javascript:void(0)" id="loginBtn">Đăng nhập</a>
        <a href="javascript:void(0)" id="newsBtn" style="display:none;">Tin mới</a>
        <a href="javascript:void(0)" id="statsBtn" style="display:none;">Thống kê</a>
        <a href="javascript:void(0)" id="changePasswordBtn" style="display:none;">Đổi mật khẩu</a>
        <a href="javascript:void(0)" id="createAccountBtn" style="display:none;">Tạo tài khoản</a>
        <a href="javascript:void(0)" id="settingsBtn" style="display:none;">Cấu hình</a>
        <a href="javascript:void(0)" id="logoutBtn" style="display:none;">Đăng xuất</a>
    </div>

    <div id="main" class="main-content">
        <div id="newsContainer"></div>
    </div>
    
    <div id="newsPage" class="page">
        <button class="back-btn" id="backFromNewsBtn">Quay lại</button>
        <div class="form-container">
            <h2 id="newsPageTitle" class="text-2xl font-bold mb-4">Viết bài mới</h2>
            <input type="text" id="newsTitle" placeholder="Tiêu đề bài viết">
            <input type="text" id="newsImageUrl" placeholder="Đường dẫn ảnh mô tả">
            <input type="text" id="newsDescription" placeholder="Mô tả ngắn">
            <div id="chaptersContainer"></div>
            <button class="add-item-btn" id="addChapterBtn">Thêm chương</button>
            <button id="submitNewsBtn" class="bg-blue-500 hover:bg-blue-600">Đăng bài</button>
        </div>
    </div>

    <div id="statsEntryPage" class="page">
        <button class="back-btn" id="backFromStatsBtn">Quay lại</button>
        <div class="form-container">
            <h2 id="statsEntryPageTitle" class="text-2xl font-bold mb-4">Nhập liệu thống kê hộ gia đình</h2>
            <div class="text-gray-600 mb-4">
                <p>Để thống kê, vui lòng nhập thông tin của các thành viên trong gia đình. Số điện thoại chỉ cần nhập cho người khai báo chính (chủ hộ).</p>
            </div>
            <div id="householdFormContainer" class="flex flex-col gap-4"></div>
            <button class="add-item-btn" id="addPersonBtn">Thêm người</button>
            <button id="saveHouseholdBtn" class="bg-green-500 hover:bg-green-600">Lưu thông tin</button>
            <div id="savedHouseholdData" class="mt-8">
                <h3 class="text-lg font-bold mb-4">Danh sách đã nhập:</h3>
                <div id="householdList" class="flex flex-col gap-4"></div>
            </div>
        </div>
    </div>

    <!-- Trang Cấu hình -->
    <div id="settingsPage" class="page">
        <button class="back-btn" id="backFromSettingsBtn">Quay lại</button>
        <div class="form-container">
            <h2 class="text-2xl font-bold mb-4">Cấu hình</h2>
            <p class="text-gray-600 mb-4">Để tải ảnh lên, bạn có thể sử dụng các dịch vụ lưu trữ hình ảnh miễn phí. Sau khi tải lên, bạn sẽ nhận được một đường link để dán vào trường "Đường dẫn ảnh mô tả".</p>
            <div class="mt-6">
                <h3 class="font-bold">Hướng dẫn các bước:</h3>
                <ol class="list-decimal list-inside text-gray-700 mt-2">
                    <li>Truy cập một dịch vụ lưu trữ ảnh miễn phí như <a href="https://imgur.com/upload" target="_blank" class="text-blue-500 hover:underline">Imgur</a>.</li>
                    <li>Tải ảnh của bạn lên.</li>
                    <li>Sao chép đường link của ảnh đã tải lên.</li>
                    <li>Quay lại trang "Viết bài mới" và dán đường link đó vào trường "Đường dẫn ảnh mô tả".</li>
                </ol>
            </div>
        </div>
    </div>

    <!-- The Modal -->
    <div id="loginModal" class="modal">
        <div class="modal-content">
            <span class="close-button">&times;</span>
            <h2 class="text-2xl font-bold text-center mb-4">Đăng nhập</h2>
            <input type="email" id="emailInput" placeholder="Email" required>
            <input type="password" id="passwordInput" placeholder="Mật khẩu" required>
            <button id="loginSubmitBtn">Đăng nhập</button>
            <div id="auth-status"></div>
        </div>
    </div>
    
    <!-- Change Password Modal -->
    <div id="changePasswordModal" class="modal">
        <div class="modal-content">
            <span class="close-button">&times;</span>
            <h2 class="text-2xl font-bold text-center mb-4">Đổi mật khẩu</h2>
            <input type="password" id="newPasswordInput" placeholder="Mật khẩu mới" required>
            <button id="changePasswordSubmitBtn">Xác nhận</button>
            <div id="password-status"></div>
        </div>
    </div>
    
    <!-- Create Account Modal -->
    <div id="createAccountModal" class="modal">
        <div class="modal-content">
            <span class="close-button">&times;</span>
            <h2 class="text-2xl font-bold text-center mb-4">Tạo tài khoản mới</h2>
            <input type="email" id="newEmailInput" placeholder="Email" required>
            <input type="password" id="newPasswordInput2" placeholder="Mật khẩu" required>
            <button id="createAccountSubmitBtn">Tạo</button>
            <div id="create-status"></div>
        </div>
    </div>
    
    <!-- Full Article Page -->
    <div id="fullArticlePage" class="page">
        <button class="back-btn" id="backToMainBtn">Quay lại trang chính</button>
        <div class="form-container">
            <h2 id="articleTitle" class="text-3xl font-bold mb-4 text-center"></h2>
            <img id="articleImage" class="main-image" src="" alt="Hình ảnh">
            <p id="articleDescription" class="text-gray-700 mb-6"></p>
            <div id="articleChapters"></div>
            <div class="author text-sm text-gray-500 mt-6" id="articleAuthor"></div>
        </div>
    </div>

    <script type="module">
        // Firebase configuration
        const firebaseConfig = {
          apiKey: "AIzaSyDnpmDzGFRI9xO9EEtEpI08Eq7eStFlmrs",
          authDomain: "tintuc-abf6f.firebaseapp.com",
          projectId: "tintuc-abf6f",
          storageBucket: "tintuc-abf6f.firebasestorage.app",
          messagingSenderId: "331457798860",
          appId: "1:331457798860:web:5d36bb68868323669b9869",
          measurementId: "G-RX51JVRPEC"
        };
        
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';

        // Firebase Imports
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInWithEmailAndPassword, signOut, onAuthStateChanged, updatePassword, createUserWithEmailAndPassword } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, onSnapshot, query, setLogLevel, updateDoc, doc, getDocs } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        
        setLogLevel('debug');
        
        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // Global state variables
        let editingDocId = null;
        let currentPostType = 'news';
        let currentStatsPostId = null;

        // UI elements
        const sidebar = document.getElementById("mySidebar");
        const mainContent = document.getElementById("main");
        const newsPage = document.getElementById("newsPage");
        const settingsPage = document.getElementById("settingsPage");
        const newsContainer = document.getElementById("newsContainer");
        const loginBtn = document.getElementById("loginBtn");
        const newsBtn = document.getElementById("newsBtn");
        const statsBtn = document.getElementById("statsBtn");
        const logoutBtn = document.getElementById("logoutBtn");
        const changePasswordBtn = document.getElementById("changePasswordBtn");
        const createAccountBtn = document.getElementById("createAccountBtn");
        const settingsBtn = document.getElementById("settingsBtn");
        const userInfo = document.getElementById("user-info");
        const emailInput = document.getElementById("emailInput");
        const passwordInput = document.getElementById("passwordInput");
        const newsTitleInput = document.getElementById("newsTitle");
        const newsImageUrlInput = document.getElementById("newsImageUrl");
        const newsDescriptionInput = document.getElementById("newsDescription");
        const chaptersContainer = document.getElementById("chaptersContainer");
        const addChapterBtn = document.getElementById("addChapterBtn");
        const menuToggle = document.getElementById("menuToggle");
        const submitNewsBtn = document.getElementById("submitNewsBtn");
        const newsPageTitle = document.getElementById("newsPageTitle");
        
        const fullArticlePage = document.getElementById("fullArticlePage");
        const articleTitle = document.getElementById("articleTitle");
        const articleImage = document.getElementById("articleImage");
        const articleDescription = document.getElementById("articleDescription");
        const articleChapters = document.getElementById("articleChapters");
        const articleAuthor = document.getElementById("articleAuthor");

        const statsEntryPage = document.getElementById("statsEntryPage");
        const statsEntryPageTitle = document.getElementById("statsEntryPageTitle");
        const householdFormContainer = document.getElementById("householdFormContainer");
        const addPersonBtn = document.getElementById("addPersonBtn");
        const saveHouseholdBtn = document.getElementById("saveHouseholdBtn");
        const householdList = document.getElementById("householdList");

        const backToMainBtn = document.getElementById("backToMainBtn");
        const backFromSettingsBtn = document.getElementById("backFromSettingsBtn");
        const backFromNewsBtn = document.getElementById("backFromNewsBtn");
        const backFromStatsBtn = document.getElementById("backFromStatsBtn");

        // Modals
        const loginModal = document.getElementById("loginModal");
        const changePasswordModal = document.getElementById("changePasswordModal");
        const createAccountModal = document.getElementById("createAccountModal");
        
        // Close buttons for modals
        document.querySelectorAll(".close-button").forEach(btn => {
            btn.onclick = function() {
                btn.closest('.modal').style.display = "none";
            }
        });
        
        window.onclick = function(event) {
            if (event.target.classList.contains('modal')) {
                event.target.style.display = "none";
            }
        }
        
        // Login functionality
        loginBtn.onclick = () => loginModal.style.display = "flex";
        
        document.getElementById("loginSubmitBtn").onclick = async function() {
            const authStatus = document.getElementById("auth-status");
            const email = emailInput.value;
            const password = passwordInput.value;
            authStatus.textContent = "Đang đăng nhập...";

            try {
                await signInWithEmailAndPassword(auth, email, password);
                authStatus.textContent = "Đăng nhập thành công!";
                loginModal.style.display = "none";
            } catch (error) {
                console.error("Lỗi đăng nhập:", error);
                authStatus.textContent = "Lỗi: " + error.message;
            }
        };
        
        // Logout functionality
        logoutBtn.onclick = () => signOut(auth).catch(error => console.error("Lỗi đăng xuất:", error));
        
        // Change password functionality
        changePasswordBtn.onclick = () => changePasswordModal.style.display = "flex";
        
        document.getElementById("changePasswordSubmitBtn").onclick = async function() {
            const newPasswordInput = document.getElementById("newPasswordInput");
            const passwordStatus = document.getElementById("password-status");
            const user = auth.currentUser;
            if (user) {
                try {
                    await updatePassword(user, newPasswordInput.value);
                    passwordStatus.textContent = "Đổi mật khẩu thành công!";
                } catch (error) {
                    console.error("Lỗi đổi mật khẩu:", error);
                    passwordStatus.textContent = "Lỗi: " + error.message;
                }
            }
        };
        
        // Create account functionality
        createAccountBtn.onclick = () => createAccountModal.style.display = "flex";
        
        document.getElementById("createAccountSubmitBtn").onclick = async function() {
            const newEmailInput = document.getElementById("newEmailInput");
            const newPasswordInput2 = document.getElementById("newPasswordInput2");
            const createStatus = document.getElementById("create-status");
            try {
                await createUserWithEmailAndPassword(auth, newEmailInput.value, newPasswordInput2.value);
                createStatus.textContent = "Tạo tài khoản thành công!";
            } catch (error) {
                console.error("Lỗi tạo tài khoản:", error);
                createStatus.textContent = "Lỗi: " + error.message;
            }
        };
        
        // Add chapter functionality for news/stats post
        function addChapter(title = '', imageUrl = '', content = '') {
            const chapterDiv = document.createElement('div');
            chapterDiv.classList.add('item-card');
            chapterDiv.innerHTML = `
                <input type="text" class="chapter-title-input" placeholder="Tiêu đề chương" value="${title}">
                <input type="text" class="chapter-image-input" placeholder="Đường dẫn ảnh chương" value="${imageUrl}">
                <textarea class="chapter-content-input h-32" placeholder="Nội dung chương">${content}</textarea>
                <button class="remove-item-btn">Xóa chương</button>
            `;
            chaptersContainer.appendChild(chapterDiv);
            chapterDiv.querySelector('.remove-item-btn').onclick = () => chapterDiv.remove();
        }
        addChapterBtn.onclick = () => addChapter();

        // Submit news/stats functionality
        submitNewsBtn.onclick = async function() {
            const user = auth.currentUser;
            if (!user) return;
            
            const postData = {
                title: newsTitleInput.value,
                description: newsDescriptionInput.value,
                imageUrl: newsImageUrlInput.value || '',
                chapters: Array.from(document.querySelectorAll('.item-card')).map(el => ({
                    title: el.querySelector('.chapter-title-input').value,
                    imageUrl: el.querySelector('.chapter-image-input').value || '',
                    content: el.querySelector('.chapter-content-input').value
                })),
                author: user.email,
                type: currentPostType,
                createdAt: new Date()
            };
            
            if (!postData.title || !postData.description) {
                console.log("Vui lòng điền đầy đủ tiêu đề và mô tả.");
                return;
            }

            try {
                if (editingDocId) {
                    await updateDoc(doc(db, `/artifacts/${appId}/public/data/news`, editingDocId), postData);
                    console.log("Bài viết đã được cập nhật thành công!");
                } else {
                    await addDoc(collection(db, `/artifacts/${appId}/public/data/news`), postData);
                    console.log("Bài viết đã được đăng thành công!");
                }
            } catch (e) {
                console.error("Lỗi khi đăng/cập nhật bài viết: ", e);
            }
            
            // Clear inputs and switch back to main page
            editingDocId = null;
            submitNewsBtn.textContent = "Đăng bài";
            newsTitleInput.value = newsImageUrlInput.value = newsDescriptionInput.value = "";
            chaptersContainer.innerHTML = "";
            showPage('main');
        };
        
        function showPage(pageId) {
            document.querySelectorAll('.page, .main-content').forEach(page => page.style.display = 'none');
            document.getElementById(pageId).style.display = 'flex';
        }

        // Navigation button functionality
        newsBtn.onclick = () => {
            currentPostType = 'news';
            newsPageTitle.textContent = "Viết tin mới";
            editingDocId = null;
            submitNewsBtn.textContent = "Đăng bài";
            newsTitleInput.value = newsImageUrlInput.value = newsDescriptionInput.value = "";
            chaptersContainer.innerHTML = "";
            addChapter();
            showPage('newsPage');
        };

        statsBtn.onclick = () => {
            currentPostType = 'stats';
            newsPageTitle.textContent = "Viết bài thống kê";
            editingDocId = null;
            submitNewsBtn.textContent = "Đăng bài";
            newsTitleInput.value = newsImageUrlInput.value = newsDescriptionInput.value = "";
            chaptersContainer.innerHTML = "";
            addChapter();
            showPage('newsPage');
        };

        settingsBtn.onclick = () => showPage('settingsPage');
        backToMainBtn.onclick = () => showPage('main');
        backFromSettingsBtn.onclick = () => showPage('main');
        backFromNewsBtn.onclick = () => showPage('main');
        backFromStatsBtn.onclick = () => showPage('main');

        // Auth state listener
        onAuthStateChanged(auth, (user) => {
            if (user) {
                userInfo.textContent = `Xin chào, ${user.email}`;
                userInfo.style.display = "block";
                loginBtn.style.display = "none";
                logoutBtn.style.display = "block";
                changePasswordBtn.style.display = "block";
                newsBtn.style.display = "block";
                statsBtn.style.display = "block";
                settingsBtn.style.display = "block";
                if (user.email === 'admin@myapp.com') {
                    createAccountBtn.style.display = "block";
                } else {
                    createAccountBtn.style.display = "none";
                }
            } else {
                userInfo.style.display = "none";
                loginBtn.style.display = "block";
                logoutBtn.style.display = "none";
                changePasswordBtn.style.display = "none";
                createAccountBtn.style.display = "none";
                settingsBtn.style.display = "none";
                statsBtn.style.display = "none";
                passwordInput.value = "";
            }
        });

        // Listen for news and stats articles
        onSnapshot(query(collection(db, `/artifacts/${appId}/public/data/news`)), (querySnapshot) => {
            const newsList = querySnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() })).sort((a, b) => b.createdAt.toDate() - a.createdAt.toDate());
            
            newsContainer.innerHTML = '';
            const user = auth.currentUser;
            newsList.forEach(news => {
                const card = document.createElement('div');
                card.classList.add('news-card');
                
                let imageHtml = news.imageUrl ? `<img src="${news.imageUrl}" alt="${news.title}" onerror="this.style.display='none'">` : '';
                card.innerHTML = `
                    ${imageHtml}
                    <h3>${news.title}</h3>
                    <p>${news.description}</p>
                    <div class="author">Đăng bởi: ${news.author}</div>
                    <button class="edit-news-btn">Sửa</button>
                `;
                newsContainer.appendChild(card);

                const editBtn = card.querySelector('.edit-news-btn');
                if (user && user.email === news.author) {
                    editBtn.style.display = 'block';
                } else {
                    editBtn.style.display = 'none';
                }

                editBtn.onclick = (e) => {
                    e.stopPropagation();
                    editingDocId = news.id;
                    currentPostType = news.type;
                    newsPageTitle.textContent = news.type === 'news' ? "Viết tin mới" : "Viết bài thống kê";
                    newsTitleInput.value = news.title;
                    newsImageUrlInput.value = news.imageUrl;
                    newsDescriptionInput.value = news.description;
                    
                    chaptersContainer.innerHTML = "";
                    news.chapters.forEach(chapter => addChapter(chapter.title, chapter.imageUrl, chapter.content));
                    
                    submitNewsBtn.textContent = "Cập nhật bài viết";
                    showPage('newsPage');
                };

                card.onclick = () => {
                    if (news.type === 'news') {
                        // Show full article page for news
                        articleTitle.textContent = news.title;
                        articleDescription.textContent = news.description;
                        articleAuthor.textContent = `Đăng bởi: ${news.author}`;

                        if (news.imageUrl) {
                            articleImage.src = news.imageUrl;
                            articleImage.style.display = 'block';
                        } else {
                            articleImage.style.display = 'none';
                        }
                        
                        articleChapters.innerHTML = '';
                        if (news.chapters) {
                          news.chapters.forEach(chapter => {
                              const chapterDiv = document.createElement('div');
                              chapterDiv.classList.add('chapter');
                              chapterDiv.innerHTML = `
                                  <h4 class="chapter-title">${chapter.title}</h4>
                                  ${chapter.imageUrl ? `<img src="${chapter.imageUrl}" class="chapter-image" alt="${chapter.title}" onerror="this.style.display='none'">` : ''}
                                  <p class="chapter-content">${chapter.content}</p>
                              `;
                              articleChapters.appendChild(chapterDiv);
                          });
                        }
                        showPage('fullArticlePage');
                        window.scrollTo(0, 0);
                    } else if (news.type === 'stats') {
                        // Show stats entry page for stats
                        currentStatsPostId = news.id;
                        statsEntryPageTitle.textContent = `Thống kê cho: ${news.title}`;
                        showPage('statsEntryPage');
                    }
                };
            });
        });

        // Logic for Stats Entry Page
        function addPerson(person = {}) {
            const personDiv = document.createElement('div');
            personDiv.classList.add('item-card');
            personDiv.innerHTML = `
                <input type="text" class="person-name-input" placeholder="Tên" value="${person.name || ''}" required>
                <input type="text" class="person-phone-input" placeholder="Số điện thoại" value="${person.phone || ''}">
                <input type="text" class="person-relationship-input" placeholder="Mối quan hệ" value="${person.relationship || ''}">
                <button class="remove-item-btn">Xóa người</button>
            `;
            householdFormContainer.appendChild(personDiv);
            personDiv.querySelector('.remove-item-btn').onclick = () => personDiv.remove();
        }

        addPersonBtn.onclick = () => addPerson();

        saveHouseholdBtn.onclick = async function() {
            const user = auth.currentUser;
            if (!user || !currentStatsPostId) return;

            const householdData = Array.from(document.querySelectorAll('.item-card')).map(el => ({
                name: el.querySelector('.person-name-input').value,
                phone: el.querySelector('.person-phone-input').value || '',
                relationship: el.querySelector('.person-relationship-input').value || '',
            }));

            try {
                await addDoc(collection(db, `/artifacts/${appId}/public/data/news/${currentStatsPostId}/households`), {
                    members: householdData,
                    declaredBy: user.email,
                    declaredAt: new Date()
                });
                console.log("Dữ liệu hộ gia đình đã được lưu thành công!");
                // Clear the form after saving
                householdFormContainer.innerHTML = '';
                addPerson(); // Add a new blank entry
            } catch (e) {
                console.error("Lỗi khi lưu dữ liệu hộ gia đình: ", e);
            }
        };

        // Listen for household data changes on the current stats post
        onSnapshot(query(collection(db, `/artifacts/${appId}/public/data/news/${currentStatsPostId || 'placeholder'}/households`)), (querySnapshot) => {
            householdList.innerHTML = '';
            querySnapshot.forEach(doc => {
                const data = doc.data();
                const listDiv = document.createElement('div');
                listDiv.classList.add('member-item');
                let memberInfo = ``;
                data.members.forEach(member => {
                    memberInfo += `<p><strong>${member.name}</strong> - ${member.relationship} ${member.phone ? `(${member.phone})` : ''}</p>`;
                });
                listDiv.innerHTML = `
                    <p class="text-sm text-gray-500">Được khai báo bởi: ${data.declaredBy} lúc ${data.declaredAt.toDate().toLocaleString('vi-VN')}</p>
                    ${memberInfo}
                `;
                householdList.appendChild(listDiv);
            });
        });


        // Toggle sidebar using a button
        menuToggle.onclick = () => {
            sidebar.classList.toggle('active');
            mainContent.classList.toggle('pushed');
        };

        // Close sidebar when clicking outside on mobile
        window.addEventListener('click', (e) => {
            if (sidebar.classList.contains('active') && !sidebar.contains(e.target) && !menuToggle.contains(e.target)) {
                sidebar.classList.remove('active');
                mainContent.classList.remove('pushed');
            }
        });
        
        // Initial state
        addChapter();
        addPerson();
    </script>
</body>
</html>
